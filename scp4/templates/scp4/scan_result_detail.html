{% extends 'scp4/base.html' %}
{% load static %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô - Code Scan Pro{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary-color: #4CAF50;
        --secondary-color: #6c757d;
        --background-main: #121212;
        --background-container: #1e1e1e;
        --text-color: #f0f0f0;
        --border-color: #444;
        --critical-color: #dc3545;
        --high-color: #e55353;
        --medium-color: #ffc107;
        --low-color: #17a2b8;
        --safe-color: #28a745;
    }

    body {
        background-color: var(--background-main);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .main-container {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 30px;
    }
    
    .content-area {
        background-color: var(--background-container);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
        color: var(--text-color);
    }
    
    .sidebar {
        background-color: var(--background-container);
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
        color: var(--text-color);
        height: fit-content;
        position: sticky;
        top: 20px;
    }
    
    .top-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }
    
    .back-button, .action-btn {
        background-color: transparent;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 10px 20px;
        border-radius: 20px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .back-button:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: #fff;
        transform: translateY(-2px);
    }
    
    .action-btn.pdf {
        background-color: var(--critical-color);
        border-color: var(--critical-color);
        color: white;
    }
    
    .action-btn.pdf:hover {
        background-color: #bb2d3b;
        transform: translateY(-2px);
    }
    
    .scan-header {
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    
    .scan-title {
        font-size: 2.2em;
        color: var(--primary-color);
        margin: 0 0 10px 0;
        font-weight: 600;
    }
    
    .scan-meta {
        color: var(--secondary-color);
        font-size: 1em;
    }
    
    .section-title {
        font-size: 1.6em;
        color: var(--text-color);
        margin: 30px 0 15px 0;
        font-weight: 500;
    }
    
    .code-display {
        background-color: #0d0d0d;
        color: #4CAF50;
        padding: 20px;
        border-radius: 10px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: 'Fira Code', 'Courier New', Courier, monospace;
        line-height: 1.5;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .vulnerability-item {
        background-color: #2a2a2a;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 6px solid;
        transition: transform 0.3s ease;
    }
    
    .vulnerability-item:hover {
        transform: translateY(-2px);
    }
    
    .vuln-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }
    
    .severity-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .vulnerability-item[data-severity="Critical"] { 
        border-left-color: var(--critical-color); 
    }
    .vulnerability-item[data-severity="Critical"] .severity-badge { 
        background-color: var(--critical-color); 
    }
    .vulnerability-item[data-severity="High"] { 
        border-left-color: var(--high-color); 
    }
    .vulnerability-item[data-severity="High"] .severity-badge { 
        background-color: var(--high-color); 
    }
    .vulnerability-item[data-severity="Medium"] { 
        border-left-color: var(--medium-color); 
    }
    .vulnerability-item[data-severity="Medium"] .severity-badge { 
        background-color: var(--medium-color); 
        color: #212529; 
    }
    .vulnerability-item[data-severity="Low"] { 
        border-left-color: var(--low-color); 
    }
    .vulnerability-item[data-severity="Low"] .severity-badge { 
        background-color: var(--low-color); 
    }
    
    .safe-message, .error-message {
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        text-align: center;
    }
    
    .safe-message {
        background-color: #2e4a30;
        color: #92e092;
        border: 1px solid #3b633b;
    }
    
    .error-message {
        background-color: #4f2222;
        color: #ff8b8b;
        border: 1px solid #6d2f2f;
    }
    
    /* Sidebar Styles */
    .sidebar-title {
        font-size: 1.4em;
        color: var(--primary-color);
        margin: 0 0 20px 0;
        font-weight: 600;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
    }
    
    .stats-summary {
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #444;
    }
    
    .stat-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
    }
    
    .stat-label {
        color: var(--secondary-color);
    }
    
    .stat-value {
        font-weight: bold;
    }
    
    .stat-value.critical { color: var(--critical-color); }
    .stat-value.medium { color: var(--medium-color); }
    .stat-value.low { color: var(--low-color); }
    .stat-value.safe { color: var(--safe-color); }
    
    .other-scans-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .other-scan-item {
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        border-left: 3px solid var(--primary-color);
    }
    
    .other-scan-item:hover {
        background-color: #333;
        transform: translateX(5px);
    }
    
    .other-scan-item.current {
        background-color: var(--primary-color);
        color: #000;
        font-weight: bold;
    }
    
    .other-scan-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }
    
    .scan-date {
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    
    .scan-summary {
        font-size: 0.8em;
        opacity: 0.8;
    }
    
    .no-other-scans {
        text-align: center;
        color: var(--secondary-color);
        font-style: italic;
        padding: 20px;
    }
    
    @media (max-width: 768px) {
        .main-container {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .sidebar {
            position: static;
            order: -1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Main Content Area -->
    <div class="content-area">
        <div class="top-actions">
            <a href="{% url 'scp4:scan_history' %}" class="back-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5a.5.5 0 0 0 .5-.5z"/>
                </svg>
                ‡∏Å‡∏•‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            </a>
            
            <a href="{% url 'scp4:export_scan_report_pdf' scan_result.id %}" target="_blank" class="action-btn pdf">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                </svg>
                Export PDF
            </a>
        </div>

        <div class="scan-header">
            <h1 class="scan-title">üîç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h1>
            <div class="scan-meta">
                <p>üìÖ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ scan_result.scanned_at|date:"d M Y H:i:s" }}</p>
                {% if scan_result.file_name %}
                    <p>üìÑ ‡πÑ‡∏ü‡∏•‡πå: {{ scan_result.file_name }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Code Section -->
        <div class="code-section">
            <h2 class="section-title">üìù ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
            <pre class="code-display">{{ code|escape }}</pre>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <h2 class="section-title">üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
            
            {% if ollama_error %}
                <div class="error-message">
                    <h3>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö AI</h3>
                    <p>{{ raw_output_text|escape }}</p>
                </div>
            {% elif no_vuln_found %}
                <div class="safe-message">
                    <h3>‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢!</h3>
                    <p>AI ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ</p>
                    <small style="opacity: 0.7;">
                        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ 100% ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </small>
                </div>
            {% else %}
                <div class="vulnerabilities-list">
                    {% for vuln in vulnerabilities %}
                        <div class="vulnerability-item" data-severity="{{ vuln.severity }}">
                            <div class="vuln-header">
                                <h4 style="margin: 0;">{{ vuln.name }}</h4>
                                <span class="severity-badge">{{ vuln.severity }}</span>
                            </div>
                            <div class="vuln-details">
                                <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> {{ vuln.description }}</p>
                                <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong> {{ vuln.remediation }}</p>
                                {% if vuln.code_snippet %}
                                    <div style="margin-top: 15px;">
                                        <strong>‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á:</strong>
                                        <pre class="code-display" style="margin-top: 10px; font-size: 0.9em;">{{ vuln.code_snippet|escape }}</pre>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Stats Summary -->
        <div class="stats-section">
            <h3 class="sidebar-title">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
            <div class="stats-summary">
                <div class="stat-item">
                    <span class="stat-label">‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                    <span class="stat-value {% if total_vulnerabilities > 0 %}critical{% else %}safe{% endif %}">
                        {{ total_vulnerabilities }}
                    </span>
                </div>
                {% if high_severity_count > 0 %}
                <div class="stat-item">
                    <span class="stat-label">Critical/High:</span>
                    <span class="stat-value critical">{{ high_severity_count }}</span>
                </div>
                {% endif %}
                {% if medium_severity_count > 0 %}
                <div class="stat-item">
                    <span class="stat-label">Medium:</span>
                    <span class="stat-value medium">{{ medium_severity_count }}</span>
                </div>
                {% endif %}
                {% if low_severity_count > 0 %}
                <div class="stat-item">
                    <span class="stat-label">Low:</span>
                    <span class="stat-value low">{{ low_severity_count }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Other Scans -->
        <div class="other-scans-section">
            <h3 class="sidebar-title">üìã ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3>
            {% if other_scans %}
                <ul class="other-scans-list">
                    {% for scan in other_scans %}
                        <li class="other-scan-item">
                            <a href="{% url 'scp4:view_scan_result' scan.id %}" class="other-scan-link">
                                <div class="scan-date">{{ scan.scanned_at|date:"d/m/Y H:i" }}</div>
                                <div class="scan-summary">
                                    {% if scan.vulnerabilities.count > 0 %}
                                        ‚ö†Ô∏è {{ scan.vulnerabilities.count }} ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà
                                    {% else %}
                                        ‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                                    {% endif %}
                                </div>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="{% url 'scp4:scan_history' %}" style="color: var(--primary-color); text-decoration: none; font-size: 0.9em;">
                        ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí
                    </a>
                </div>
            {% else %}
                <div class="no-other-scans">
                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏∑‡πà‡∏ô
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}